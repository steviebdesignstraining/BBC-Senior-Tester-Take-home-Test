name: Deploy Test Reports to GitHub Pages

on:
  workflow_run:
    workflows:
      - "Tests & Performance"
    branches: [main]
    types:
      - completed

jobs:
  deploy:
    name: Deploy Reports
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------
      # Prepare gh-pages branch
      # -------------------------------
      - name: Prepare gh-pages branch
        run: |
          git fetch origin gh-pages || true
          git checkout gh-pages || git checkout -b gh-pages
          git rm -rf .
          git checkout main -- index.html
          mkdir -p playwright-report
          mkdir -p performance-tests/k6/reports

      # -------------------------------
      # Download Playwright report
      # -------------------------------
      - name: Download Playwright Report
        uses: actions/download-artifact@v4
        with:
          name: ortoni-report
          path: playwright-report

      # -------------------------------
      # Download k6 reports
      # -------------------------------
      - name: Download k6 Reports
        uses: actions/download-artifact@v4
        with:
          name: k6-reports
          path: performance-tests/k6/reports

      # -------------------------------
      # Extract test statistics
      # -------------------------------
      - name: Extract test statistics
        run: |
          mkdir -p stats
          node scripts/extract-playwright-stats.js
          node scripts/extract-k6-stats.js

      # -------------------------------
      # Inject stats into dashboard
      # -------------------------------
      - name: Inject stats into dashboard
        run: node scripts/inject-stats.js

      # -------------------------------
      # Save historical snapshot
      # -------------------------------
      - name: Save historical snapshot
        run: node scripts/save-history.js

      # -------------------------------
      # Commit & deploy
      # -------------------------------
      - name: Commit and push to gh-pages
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .
          git commit -m "Update test reports $(date)" || echo "No changes"
          git push origin gh-pages

      - name: Output GitHub Pages URL
        run: |
          echo "âœ… Reports deployed:"
          echo "https://steviebdesignstraining.github.io/BBC-Senior-Tester-Take-home-Test/"
