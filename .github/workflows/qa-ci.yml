name: QA CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: read
  pages: write
  id-token: write

env:
  REPORT_ROOT: site
  GITHUB_SHA: ${{ github.sha }}
  GITHUB_REF: ${{ github.ref }}
  GITHUB_RUN_ID: ${{ github.run_id }}
  GITHUB_RUN_NUMBER: ${{ github.run_number }}
  GITHUB_WORKFLOW: ${{ github.workflow }}
  GITHUB_EVENT_NAME: ${{ github.event_name }}

jobs:
  playwright:
    name: Playwright UI & API Tests
    runs-on: ubuntu-latest
    environment: Playwright standard Env

    env:
      BASE_URL: ${{ secrets.BASE_URL }}
      TEST_DATA_API: ${{ secrets.TEST_DATA_API }}
      TEST_DATA_SCHEMA: ${{ secrets.TEST_DATA_SCHEMA }}
      TIMEOUT: ${{ secrets.TIMEOUT }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests
        id: playwright_tests
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â–¶ STARTING PLAYWRIGHT TESTS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ”§ Test Configuration:"
          echo "  BASE_URL: ${BASE_URL}"
          echo "  TEST_DATA_API: ${TEST_DATA_API}"
          echo "  TIMEOUT: ${TIMEOUT}"
          echo ""
          echo "ğŸ“‹ Test Files to Execute:"
          find tests -name "*.spec.ts" -type f
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # Run tests with multiple reporters for better visibility
          if npx playwright test \
            --reporter=list \
            --reporter=ortoni-report \
            --reporter=html; then
            
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… PLAYWRIGHT TESTS PASSED"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "PLAYWRIGHT_STATUS=PASSED" >> $GITHUB_ENV
            echo "playwright_status=PASSED" >> $GITHUB_OUTPUT
            
            # Generate Ortoni report if not already generated
            if [ ! -f "ortoni-report.html" ]; then
              echo "ğŸ“„ Generating Ortoni report..."
              npx ortoni generate --output ortoni-report.html
            fi
          else
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ PLAYWRIGHT TESTS FAILED"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "PLAYWRIGHT_STATUS=FAILED" >> $GITHUB_ENV
            echo "playwright_status=FAILED" >> $GITHUB_OUTPUT
            
            # Try to generate Ortoni report even if tests failed
            if [ ! -f "ortoni-report.html" ]; then
              echo "ğŸ“„ Attempting to generate Ortoni report from failed tests..."
              npx ortoni generate --output ortoni-report.html 2>/dev/null || echo "âš ï¸  Could not generate Ortoni report"
            fi
          fi
          
          echo ""
          echo "ğŸ“Š Test Results Summary:"
          if [ -f "test-results/.last-run.json" ]; then
            cat test-results/.last-run.json
          fi
        continue-on-error: true

      - name: Prepare reports directory
        run: |
          echo "ğŸ“¦ Preparing reports directory..."
          mkdir -p site/reports
          
          echo ""
          echo "ğŸ“‚ Available report files:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Check for ortoni report
          if [ -f "ortoni-report.html" ]; then
            echo "âœ… ortoni-report.html found ($(stat -c%s ortoni-report.html 2>/dev/null || stat -f%z ortoni-report.html) bytes)"
            cp ortoni-report.html site/reports/
          else
            echo "âš ï¸ ortoni-report.html not found"
          fi
          
          # Check for reports directory
          if [ -d "reports" ]; then
            echo "âœ… reports/ directory found"
            echo "   Contents:"
            ls -lh reports/ | head -20
            cp -r reports/* site/reports/ 2>/dev/null || true
          else
            echo "âš ï¸ reports/ directory not found"
          fi
          
          # Check for playwright-report
          if [ -d "playwright-report" ]; then
            echo "âœ… playwright-report/ directory found"
            cp -r playwright-report site/ 2>/dev/null || true
          fi
          
          echo ""
          echo "ğŸ“Š Final site/reports structure:"
          ls -lh site/reports/ 2>/dev/null || echo "Empty"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Generate initial dashboard
        env:
          PLAYWRIGHT_STATUS: ${{ env.PLAYWRIGHT_STATUS }}
          K6_STATUS: PENDING
        run: |
          echo "ğŸ¨ Generating initial dashboard..."
          node scripts/update-index.js

      - name: Upload Playwright reports
        uses: actions/upload-artifact@v4
        with:
          name: playwright-reports
          path: site
          retention-days: 30
      
      - name: Playwright test summary
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š PLAYWRIGHT TEST EXECUTION SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Status: ${{ env.PLAYWRIGHT_STATUS }}"
          echo "Test Files Executed:"
          find tests -name "*.spec.ts" -type f | while read file; do
            echo "  - $file"
          done
          echo ""
          echo "Reports Generated:"
          find site -name "*.html" -type f | while read file; do
            echo "  - $file ($(stat -c%s $file 2>/dev/null || stat -f%z $file) bytes)"
          done
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    outputs:
      playwright_status: ${{ steps.playwright_tests.outputs.playwright_status }}

  k6:
    name: k6 Performance Tests
    runs-on: ubuntu-latest
    needs: playwright
    environment: Playwright standard Env
    continue-on-error: true

    strategy:
      matrix:
        test: [load, performance, stress, security]

    env:
      BASE_URL: ${{ secrets.BASE_URL }}
      TEST_DATA_API: ${{ secrets.TEST_DATA_API }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Run k6 ${{ matrix.test }} test
        id: k6_test
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â–¶ STARTING K6 ${{ matrix.test }} TEST"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ”§ Test Configuration:"
          echo "  Test Type: ${{ matrix.test }}"
          echo "  Test File: k6/${{ matrix.test }}.test.js"
          echo "  BASE_URL: ${BASE_URL}"
          echo "  Output: k6-results/${{ matrix.test }}.json"
          echo ""
          
          # Check if backup test file exists first, then fallback to original
          TEST_FILE=""
          if [ -f "k6/backup-${{ matrix.test }}.test.js" ]; then
            TEST_FILE="k6/backup-${{ matrix.test }}.test.js"
            echo "âœ… Using backup test file: ${TEST_FILE}"
          elif [ -f "k6/${{ matrix.test }}.test.js" ]; then
            TEST_FILE="k6/${{ matrix.test }}.test.js"
            echo "âœ… Using original test file: ${TEST_FILE}"
          else
            echo "âŒ ERROR: No test file found!"
            echo "   Checked: k6/backup-${{ matrix.test }}.test.js"
            echo "   Checked: k6/${{ matrix.test }}.test.js"
            exit 1
          fi
          
          echo ""
          echo "ğŸ“‹ Test File Preview (first 30 lines):"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          head -30 ${TEST_FILE}
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸš€ Executing k6 test..."
          echo ""
          
          mkdir -p k6-results
          
          # Run k6 with verbose output
          if k6 run \
            --out json=k6-results/${{ matrix.test }}.json \
            --summary-export=k6-results/${{ matrix.test }}-summary.json \
            --verbose \
            ${TEST_FILE}; then
            
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… K6 ${{ matrix.test }} TEST PASSED"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "k6_status=PASSED" >> $GITHUB_OUTPUT
            
            # Show summary if available
            if [ -f "k6-results/${{ matrix.test }}-summary.json" ]; then
              echo ""
              echo "ğŸ“Š Test Summary:"
              cat k6-results/${{ matrix.test }}-summary.json | jq '.' || cat k6-results/${{ matrix.test }}-summary.json
            fi
          else
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ K6 ${{ matrix.test }} TEST FAILED"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "k6_status=FAILED" >> $GITHUB_OUTPUT
          fi
          
          echo ""
          echo "ğŸ“ Generated files:"
          ls -lh k6-results/
        continue-on-error: true

      - name: Generate k6 HTML report
        run: |
          echo "ğŸ“Š Generating HTML report for ${{ matrix.test }} test..."
          echo ""
          
          mkdir -p site/k6/${{ matrix.test }}
          
          # Check for required files
          echo "ğŸ” Checking for required files:"
          if [ -f "scripts/k6-json-to-html.js" ]; then
            echo "  âœ… scripts/k6-json-to-html.js found"
          else
            echo "  âŒ scripts/k6-json-to-html.js NOT found"
          fi
          
          if [ -f "k6-results/${{ matrix.test }}.json" ]; then
            SIZE=$(stat -c%s k6-results/${{ matrix.test }}.json 2>/dev/null || stat -f%z k6-results/${{ matrix.test }}.json)
            echo "  âœ… k6-results/${{ matrix.test }}.json found (${SIZE} bytes)"
            
            # Check if file is too large (>100MB)
            if [ "$SIZE" -gt 104857600 ]; then
              echo "  âš ï¸  WARNING: JSON file is very large (>100MB), report generation may fail"
            fi
          else
            echo "  âŒ k6-results/${{ matrix.test }}.json NOT found"
          fi
          
          echo ""
          
          if [ -f "scripts/k6-json-to-html.js" ] && [ -f "k6-results/${{ matrix.test }}.json" ]; then
            echo "âœ… Generating HTML report..."
            
            # Run with error handling - don't fail the job if report generation fails
            if timeout 300 node scripts/k6-json-to-html.js \
              k6-results/${{ matrix.test }}.json \
              site/k6/${{ matrix.test }}/index.html 2>&1; then
              
              if [ -f "site/k6/${{ matrix.test }}/index.html" ]; then
                echo "âœ… HTML report generated successfully"
                echo "   Location: site/k6/${{ matrix.test }}/index.html"
                echo "   Size: $(stat -c%s site/k6/${{ matrix.test }}/index.html 2>/dev/null || stat -f%z site/k6/${{ matrix.test }}/index.html) bytes"
              else
                echo "âš ï¸  Report script ran but no HTML file was created"
                echo "<html><body><h1>k6 ${{ matrix.test }} Test</h1><p>Report generation completed but no output file was created.</p></body></html>" > site/k6/${{ matrix.test }}/index.html
              fi
            else
              EXIT_CODE=$?
              echo "âš ï¸  Report generation failed or timed out (exit code: ${EXIT_CODE})"
              echo "<html><body><h1>k6 ${{ matrix.test }} Test</h1><p>Report generation failed. The JSON file may be too large or malformed.</p><p>Check the raw k6 results in the artifacts.</p></body></html>" > site/k6/${{ matrix.test }}/index.html
            fi
          else
            echo "âš ï¸ Missing required files, creating placeholder..."
            echo "<html><body><h1>k6 ${{ matrix.test }} Test</h1><p>Test completed but report files are missing.</p></body></html>" > site/k6/${{ matrix.test }}/index.html
          fi
          
          echo ""
          echo "ğŸ“ k6 report directory contents:"
          ls -lh site/k6/${{ matrix.test }}/
        continue-on-error: true
      
      - name: Generate k6 summary for Ortoni report
        run: |
          echo "ğŸ“Š Generating k6 summary for Ortoni report..."
          
          # Create k6 summary data
          mkdir -p site/k6-summary
          
          # Extract key metrics from k6 results using our custom script
          if [ -f "scripts/extract-k6-stats.js" ]; then
            echo "âœ… Using custom k6 stats extractor..."
            node scripts/extract-k6-stats.js
          else
            echo "âš ï¸  Custom k6 stats extractor not found, using basic extraction..."
            
            # Extract key metrics from k6 results
            if [ -f "k6-results/${{ matrix.test }}-summary.json" ]; then
              echo "âœ… Found k6 summary file for ${{ matrix.test }}"
              cp k6-results/${{ matrix.test }}-summary.json site/k6-summary/${{ matrix.test }}-summary.json
            fi
            
            # Create a combined k6 summary
            if [ -f "k6-results/${{ matrix.test }}.json" ]; then
              echo "âœ… Found k6 results file for ${{ matrix.test }}"
              # Extract basic stats using jq if available
              if command -v jq >/dev/null 2>&1; then
                jq '{test: "${{ matrix.test }}", timestamp: now|strftime("%Y-%m-%d %H:%M:%S"), metrics: .}' k6-results/${{ matrix.test }}.json > site/k6-summary/${{ matrix.test }}-metrics.json 2>/dev/null || echo "jq not available for detailed metrics"
              fi
            fi
          fi
        continue-on-error: true

      - name: Upload k6 report
        uses: actions/upload-artifact@v4
        with:
          name: k6-reports-${{ matrix.test }}
          path: site/k6/${{ matrix.test }}
          retention-days: 30
      
      - name: k6 test summary
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š K6 ${{ matrix.test }} TEST SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Test Type: ${{ matrix.test }}"
          echo "Status: ${{ steps.k6_test.outputs.k6_status }}"
          echo ""
          echo "Generated Files:"
          ls -lh k6-results/ 2>/dev/null || echo "No results files"
          echo ""
          echo "HTML Report:"
          ls -lh site/k6/${{ matrix.test }}/ 2>/dev/null || echo "No HTML report"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    outputs:
      k6_status: ${{ steps.k6_test.outputs.k6_status }}

  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [playwright, k6]
    if: always()
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Create site directory structure
        run: |
          echo "ğŸ“ Creating site directory structure..."
          mkdir -p site/reports
          mkdir -p site/k6/load
          mkdir -p site/k6/performance
          mkdir -p site/k6/stress
          mkdir -p site/k6/security

      - name: Download Playwright reports
        uses: actions/download-artifact@v4
        with:
          name: playwright-reports
          path: playwright-download
        continue-on-error: true

      - name: Download k6 Load Test reports
        uses: actions/download-artifact@v4
        with:
          name: k6-reports-load
          path: k6-download/load
        continue-on-error: true

      - name: Download k6 Performance Test reports
        uses: actions/download-artifact@v4
        with:
          name: k6-reports-performance
          path: k6-download/performance
        continue-on-error: true

      - name: Download k6 Stress Test reports
        uses: actions/download-artifact@v4
        with:
          name: k6-reports-stress
          path: k6-download/stress
        continue-on-error: true

      - name: Download k6 Security Test reports
        uses: actions/download-artifact@v4
        with:
          name: k6-reports-security
          path: k6-download/security
        continue-on-error: true

      - name: Download k6 Load JSON results
        uses: actions/download-artifact@v4
        with:
          name: k6-json-load
          path: k6-json-download/load
        continue-on-error: true

      - name: Download k6 Performance JSON results
        uses: actions/download-artifact@v4
        with:
          name: k6-json-performance
          path: k6-json-download/performance
        continue-on-error: true

      - name: Download k6 Stress JSON results
        uses: actions/download-artifact@v4
        with:
          name: k6-json-stress
          path: k6-json-download/stress
        continue-on-error: true

      - name: Download k6 Security JSON results
        uses: actions/download-artifact@v4
        with:
          name: k6-json-security
          path: k6-json-download/security
        continue-on-error: true

      - name: Merge all artifacts
        run: |
          echo "ğŸ“¦ Merging all artifacts into site directory..."
          
          # Copy Playwright reports
          if [ -d "playwright-download" ]; then
            echo "âœ… Merging Playwright reports..."
            cp -r playwright-download/* site/ 2>/dev/null || true
            ls -la site/reports/ || echo "No reports directory"
          fi
          
          # Copy k6 reports
          for test_type in load performance stress security; do
            if [ -d "k6-download/${test_type}" ]; then
              echo "âœ… Merging k6 ${test_type} reports..."
              cp -r k6-download/${test_type}/* site/k6/${test_type}/ 2>/dev/null || true
            else
              echo "âš ï¸ No k6 ${test_type} reports found"
            fi
          done
          
          echo ""
          echo "ğŸ“Š Final site structure:"
          tree site -L 3 2>/dev/null || find site -type f

      - name: Generate final dashboard
        env:
          PLAYWRIGHT_STATUS: ${{ needs.playwright.outputs.playwright_status || 'UNKNOWN' }}
          K6_STATUS: ${{ needs.k6.outputs.k6_status || 'UNKNOWN' }}
          BASE_URL: ${{ secrets.BASE_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ¨ Generating final dashboard..."
          echo ""
          echo "ğŸ“ Working directory: $(pwd)"
          echo ""
          echo "ğŸ”§ Environment:"
          echo "  PLAYWRIGHT_STATUS: ${PLAYWRIGHT_STATUS}"
          echo "  K6_STATUS: ${K6_STATUS}"
          echo "  GITHUB_SHA: ${GITHUB_SHA}"
          echo "  GITHUB_REF: ${GITHUB_REF}"
          echo "  GITHUB_RUN_NUMBER: ${GITHUB_RUN_NUMBER}"
          echo "  GITHUB_REPOSITORY: ${GITHUB_REPOSITORY}"
          echo ""
          
          # Verify scripts exist
          if [ ! -f "scripts/update-index.js" ]; then
            echo "âŒ ERROR: scripts/update-index.js not found!"
            echo "Available scripts:"
            ls -la scripts/
            exit 1
          fi
          
          if [ ! -f "scripts/fetch-github-data.js" ]; then
            echo "âŒ ERROR: scripts/fetch-github-data.js not found!"
            exit 1
          fi
          
          if [ ! -f "scripts/extract-k6-stats.js" ]; then
            echo "âŒ ERROR: scripts/extract-k6-stats.js not found!"
            exit 1
          fi
          
          if [ ! -f "scripts/fetch-github-pipeline-data.js" ]; then
            echo "âŒ ERROR: scripts/fetch-github-pipeline-data.js not found!"
            exit 1
          fi
          
          echo "âœ… Running GitHub data fetcher..."
          node scripts/fetch-github-data.js
          
          echo ""
          echo "âœ… Running pipeline data fetcher..."
          node scripts/fetch-github-pipeline-data.js
          
          echo ""
          echo "âœ… Preparing k6 results for dashboard...
      run: |
        mkdir -p site/k6-results
        cp k6-results/*.json site/k6-results/ || echo "No k6 JSON files found"

      - name: Validate k6 summary consistency
        run: node scripts/validate-k6-summary.js

      - name: Generate final dashboard
        run: |
          echo "ğŸ¨ Generating final dashboard...""
          node scripts/extract-k6-stats.js
          
          echo ""
          echo "âœ… Running dashboard generator..."
          node scripts/update-index.js
          
          if [ $? -eq 0 ]; then
            echo ""
            echo "âœ… Dashboard generated successfully!"
            echo ""
            if [ -f "site/index.html" ]; then
              echo "ğŸ“„ index.html size: $(wc -c < site/index.html) bytes"
              echo ""
              echo "ğŸ“„ Dashboard preview (first 40 lines):"
              head -40 site/index.html
            fi
          else
            echo ""
            echo "âŒ Dashboard generation failed!"
            exit 1
          fi

      - name: Generate final dashboard
        env:
          PLAYWRIGHT_STATUS: ${{ needs.playwright.outputs.playwright_status || 'UNKNOWN' }}
          K6_STATUS: ${{ needs.k6.outputs.k6_status || 'UNKNOWN' }}
          BASE_URL: ${{ secrets.BASE_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ¨ Generating final dashboard..."
          echo ""
          echo "ğŸ“ Working directory: $(pwd)"
          echo ""
          echo "ğŸ”§ Environment:"
          echo "  PLAYWRIGHT_STATUS: ${PLAYWRIGHT_STATUS}"
          echo "  K6_STATUS: ${K6_STATUS}"
          echo "  GITHUB_SHA: ${GITHUB_SHA}"
          echo "  GITHUB_REF: ${GITHUB_REF}"
          echo "  GITHUB_RUN_NUMBER: ${GITHUB_RUN_NUMBER}"
          echo "  GITHUB_REPOSITORY: ${GITHUB_REPOSITORY}"
          echo ""
          
          # Verify scripts exist
          if [ ! -f "scripts/update-index.js" ]; then
            echo "âŒ ERROR: scripts/update-index.js not found!"
            echo "Available scripts:"
            ls -la scripts/
            exit 1
          fi
          
          if [ ! -f "scripts/fetch-github-data.js" ]; then
            echo "âŒ ERROR: scripts/fetch-github-data.js not found!"
            exit 1
          fi
          
          if [ ! -f "scripts/extract-k6-stats.js" ]; then
            echo "âŒ ERROR: scripts/extract-k6-stats.js not found!"
            exit 1
          fi
          
          # Verify k6 summary files exist after artifact download
          echo "ğŸ” Checking for k6 summary files..."
          if [ -f "site/k6-summary/k6-summary.json" ]; then
            echo "âœ… Found k6 summary file"
            echo "ğŸ“Š K6 summary size: $(stat -c%s site/k6-summary/k6-summary.json 2>/dev/null || stat -f%z site/k6-summary/k6-summary.json) bytes"
          else
            echo "âš ï¸  No k6 summary file found - will use fallback values"
          fi
          
          echo "âœ… Running GitHub data fetcher..."
          node scripts/fetch-github-data.js
          
          echo ""
          echo "âœ… Running k6 stats extractor..."
          node scripts/extract-k6-stats.js
          
          echo ""
          echo "âœ… Running dashboard generator..."
          node scripts/update-index.js
          
          if [ $? -eq 0 ]; then
            echo ""
            echo "âœ… Dashboard generated successfully!"
            echo ""
            if [ -f "site/index.html" ]; then
              echo "ğŸ“„ index.html size: $(wc -c < site/index.html) bytes"
              echo ""
              echo "ğŸ“„ Dashboard preview (first 40 lines):"
              head -40 site/index.html
            fi
          else
            echo ""
            echo "âŒ Dashboard generation failed!"
            exit 1
          fi

      - name: Verify deployment files
        run: |
          echo "ğŸ” Verifying deployment files..."
          echo ""
          
          if [ ! -f "site/index.html" ]; then
            echo "âŒ ERROR: site/index.html not found!"
            exit 1
          fi
          
          echo "âœ… Required files:"
          echo "  - site/index.html ($(stat -c%s site/index.html 2>/dev/null || stat -f%z site/index.html) bytes)"
          
          echo ""
          echo "ğŸ“‚ All HTML files in site:"
          find site -name "*.html" -type f
          
          echo ""
          echo "ğŸ“‚ Complete site structure:"
          tree site -L 2 2>/dev/null || ls -R site

      - name: Configure GitHub Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… DEPLOYMENT SUCCESSFUL!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸŒ GitHub Pages URL:"
          echo "   ${{ steps.deployment.outputs.page_url }}"
          echo ""
          echo "ğŸ“Š Test Status:"
          echo "   Playwright: ${{ needs.playwright.outputs.playwright_status || 'UNKNOWN' }}"
          echo "   k6: ${{ needs.k6.outputs.k6_status || 'UNKNOWN' }}"
          echo ""
          echo "ğŸ”— Direct Links:"
          echo "   Dashboard: ${{ steps.deployment.outputs.page_url }}"
          echo "   Playwright: ${{ steps.deployment.outputs.page_url }}reports/ortoni-report.html"
          echo "   k6 Load: ${{ steps.deployment.outputs.page_url }}k6/load/index.html"
          echo "   k6 Performance: ${{ steps.deployment.outputs.page_url }}k6/performance/index.html"
          echo "   k6 Stress: ${{ steps.deployment.outputs.page_url }}k6/stress/index.html"
          echo "   k6 Security: ${{ steps.deployment.outputs.page_url }}k6/security/index.html"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"