name: QA CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: read
  pages: write
  id-token: write

env:
  REPORT_ROOT: public
  RUN_DATE: ${{ github.run_id }}
  RUN_TIME: ${{ github.run_number }}

jobs:
  playwright:
    name: Playwright UI & API Tests
    runs-on: ubuntu-latest
    environment: Playwright standard Env

    env:
      BASE_URL: ${{ secrets.BASE_URL }}
      TEST_DATA_API: ${{ secrets.TEST_DATA_API }}
      TEST_DATA_SCHEMA: ${{ secrets.TEST_DATA_SCHEMA }}
      TIMEOUT: ${{ secrets.TIMEOUT }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - run: npm ci
      - run: npx playwright install --with-deps

      - name: Run Playwright tests (dynamic data)
        run: |
          echo "â–¶ Running Playwright tests"
          npx playwright test || true

      - name: Prepare Ortoni report
        run: |
          mkdir -p $REPORT_ROOT/playwright
          cp -r reports/* $REPORT_ROOT/playwright/

      - name: Update index.html
        run: |
          node scripts/update-index.js \
            playwright \
            "Playwright UI & API Tests" \
            "playwright/ortoni-report.html"

      - uses: actions/upload-artifact@v4
        with:
          name: qa-reports
          path: public

  k6:
    name: k6 Performance Tests
    runs-on: ubuntu-latest
    needs: playwright
    environment: Playwright standard Env

    strategy:
      matrix:
        test:
          - load
          - performance
          - stress
          - security

    env:
      BASE_URL: ${{ secrets.BASE_URL }}
      TEST_DATA_API: ${{ secrets.TEST_DATA_API }}

    steps:
      - uses: actions/checkout@v4

      - uses: grafana/setup-k6-action@v1

      - name: Run k6 ${{ matrix.test }} test
        run: |
          mkdir -p k6-results
          k6 run \
            performance-tests/k6/${{ matrix.test }}.js \
            --out json=k6-results/${{ matrix.test }}.json || true

      - name: Generate k6 HTML report
        run: |
          mkdir -p public/k6/${{ matrix.test }}
          node scripts/k6-json-to-html.js \
            k6-results/${{ matrix.test }}.json \
            public/k6/${{ matrix.test }}/index.html || true

      - name: Update index.html
        run: |
          node scripts/update-index.js \
            k6-${{ matrix.test }} \
            "k6 ${{ matrix.test }} test" \
            "k6/${{ matrix.test }}/index.html"

      - uses: actions/upload-artifact@v4
        with:
          name: qa-reports
          path: public

  deploy:
    name: Deploy QA Reports to GitHub Pages
    runs-on: ubuntu-latest
    needs: [playwright, k6]
    if: always()

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: qa-reports
          path: public

      - uses: actions/configure-pages@v5

      - uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - uses: actions/deploy-pages@v4