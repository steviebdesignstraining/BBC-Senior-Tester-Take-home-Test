name: QA CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: read
  pages: write
  id-token: write

env:
  REPORT_ROOT: site
  RUN_DATE: ${{ github.run_id }}
  RUN_TIME: ${{ github.run_number }}

jobs:
  playwright:
    name: Playwright UI & API Tests
    runs-on: ubuntu-latest
    environment: Playwright standard Env

    env:
      BASE_URL: ${{ secrets.BASE_URL }}
      TEST_DATA_API: ${{ secrets.TEST_DATA_API }}
      TEST_DATA_SCHEMA: ${{ secrets.TEST_DATA_SCHEMA }}
      TIMEOUT: ${{ secrets.TIMEOUT }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests (dynamic data)
        run: |
          echo "▶ Running Playwright tests"
          npx playwright test || true

      - name: Prepare Ortoni report
        run: |
          mkdir -p $REPORT_ROOT/playwright
          cp -r reports/* $REPORT_ROOT/playwright/
          cp ortoni-report.html $REPORT_ROOT/

      - name: Update index.html
        run: |
          node scripts/update-index.js

      - name: Upload Playwright reports artifact
        uses: actions/upload-artifact@v4
        with:
          name: playwright-reports
          path: site

  k6:
    name: k6 Performance Tests
    runs-on: ubuntu-latest
    needs: playwright
    environment: Playwright standard Env

    strategy:
      matrix:
        test:
          - load
          - performance
          - stress
          - security

    env:
      BASE_URL: ${{ secrets.BASE_URL }}
      TEST_DATA_API: ${{ secrets.TEST_DATA_API }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Run k6 ${{ matrix.test }} test
        run: |
          mkdir -p k6-results
          k6 run \
            k6/${{ matrix.test }}.test.js \
            --out json=k6-results/${{ matrix.test }}.json || true

      - name: Generate k6 HTML report
        run: |
          mkdir -p site/k6/${{ matrix.test }}
          node ${{ github.workspace }}/scripts/k6-json-to-html.js \
            k6-results/${{ matrix.test }}.json \
            site/k6/${{ matrix.test }}/index.html || true

      - name: Update index.html
        run: |
          node scripts/update-index.js

      - name: Upload k6 reports artifact
        uses: actions/upload-artifact@v4
        with:
          name: k6-reports-${{ matrix.test }}
          path: site

  deploy:
    name: Deploy QA Reports to GitHub Pages
    runs-on: ubuntu-latest
    needs: [playwright, k6]
    if: always()
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Download Playwright reports artifact
        uses: actions/download-artifact@v4
        with:
          name: playwright-reports
          path: site

      - name: Download k6 reports artifacts
        uses: actions/download-artifact@v4
        with:
          name: k6-reports-load
          path: site

      - name: Configure GitHub Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Show deployment URL
        run: |
          echo "✅ GitHub Pages deployed successfully:"
          echo "${{ steps.deployment.outputs.page_url }}"
