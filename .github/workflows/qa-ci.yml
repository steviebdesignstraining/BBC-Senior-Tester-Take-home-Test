name: QA CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: read
  pages: write
  id-token: write

env:
  REPORT_ROOT: site
  GITHUB_SHA: ${{ github.sha }}
  GITHUB_REF: ${{ github.ref }}
  GITHUB_RUN_ID: ${{ github.run_id }}
  GITHUB_RUN_NUMBER: ${{ github.run_number }}
  GITHUB_WORKFLOW: ${{ github.workflow }}
  GITHUB_EVENT_NAME: ${{ github.event_name }}

jobs:
  playwright:
    name: Playwright UI & API Tests
    runs-on: ubuntu-latest
    environment: Playwright standard Env

    env:
      BASE_URL: ${{ secrets.BASE_URL }}
      TEST_DATA_API: ${{ secrets.TEST_DATA_API }}
      TEST_DATA_SCHEMA: ${{ secrets.TEST_DATA_SCHEMA }}
      TIMEOUT: ${{ secrets.TIMEOUT }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests
        id: playwright_tests
        run: |
          echo "â–¶ Running Playwright tests"
          if npx playwright test --reporter=ortoni-report; then
            echo "PLAYWRIGHT_STATUS=PASSED" >> $GITHUB_ENV
            echo "playwright_status=PASSED" >> $GITHUB_OUTPUT
          else
            echo "PLAYWRIGHT_STATUS=FAILED" >> $GITHUB_ENV
            echo "playwright_status=FAILED" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Prepare reports directory
        run: |
          mkdir -p site/reports
          
          # Copy ortoni report if it exists
          if [ -f "ortoni-report.html" ]; then
            echo "âœ… Copying ortoni-report.html to site/reports/"
            cp ortoni-report.html site/reports/
          else
            echo "âš ï¸ ortoni-report.html not found"
          fi
          
          # Copy reports directory if it exists
          if [ -d "reports" ]; then
            echo "âœ… Copying reports/ content to site/reports/"
            cp -r reports/* site/reports/ 2>/dev/null || true
          else
            echo "âš ï¸ reports/ directory not found"
          fi

      - name: Generate initial dashboard
        env:
          PLAYWRIGHT_STATUS: ${{ env.PLAYWRIGHT_STATUS }}
          K6_STATUS: PENDING
        run: |
          echo "ğŸ¨ Generating initial dashboard..."
          node scripts/create-fallback-index.js

      - name: Upload Playwright reports
        uses: actions/upload-artifact@v4
        with:
          name: playwright-reports
          path: site
          retention-days: 30

    outputs:
      playwright_status: ${{ steps.playwright_tests.outputs.playwright_status }}

  k6:
    name: k6 Performance Tests
    runs-on: ubuntu-latest
    needs: playwright
    environment: Playwright standard Env
    continue-on-error: true

    strategy:
      matrix:
        test: [load, performance, stress, security]

    env:
      BASE_URL: ${{ secrets.BASE_URL }}
      TEST_DATA_API: ${{ secrets.TEST_DATA_API }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Run k6 ${{ matrix.test }} test
        id: k6_test
        run: |
          mkdir -p k6-results
          echo "ğŸš€ Running k6 ${{ matrix.test }} test..."
          
          if k6 run k6/${{ matrix.test }}.test.js --out json=k6-results/${{ matrix.test }}.json; then
            echo "âœ… k6 ${{ matrix.test }} test passed"
            echo "k6_status=PASSED" >> $GITHUB_OUTPUT
          else
            echo "âŒ k6 ${{ matrix.test }} test failed"
            echo "k6_status=FAILED" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Generate k6 HTML report
        run: |
          mkdir -p site/k6/${{ matrix.test }}
          
          if [ -f "scripts/k6-json-to-html.js" ] && [ -f "k6-results/${{ matrix.test }}.json" ]; then
            echo "âœ… Generating HTML report for ${{ matrix.test }} test..."
            node scripts/k6-json-to-html.js \
              k6-results/${{ matrix.test }}.json \
              site/k6/${{ matrix.test }}/index.html
          else
            echo "âš ï¸ Missing script or results file for ${{ matrix.test }}"
            # Create a placeholder if report generation fails
            echo "<html><body><h1>k6 ${{ matrix.test }} Test</h1><p>Report generation pending...</p></body></html>" > site/k6/${{ matrix.test }}/index.html
          fi

      - name: Upload k6 report
        uses: actions/upload-artifact@v4
        with:
          name: k6-reports-${{ matrix.test }}
          path: site/k6/${{ matrix.test }}
          retention-days: 30

    outputs:
      k6_status: ${{ steps.k6_test.outputs.k6_status }}

  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [playwright, k6]
    if: always()
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Create site directory structure
        run: |
          echo "ğŸ“ Creating site directory structure..."
          mkdir -p site/reports
          mkdir -p site/k6/load
          mkdir -p site/k6/performance
          mkdir -p site/k6/stress
          mkdir -p site/k6/security

      - name: Download Playwright reports
        uses: actions/download-artifact@v4
        with:
          name: playwright-reports
          path: playwright-download
        continue-on-error: true

      - name: Download k6 Load Test reports
        uses: actions/download-artifact@v4
        with:
          name: k6-reports-load
          path: k6-download/load
        continue-on-error: true

      - name: Download k6 Performance Test reports
        uses: actions/download-artifact@v4
        with:
          name: k6-reports-performance
          path: k6-download/performance
        continue-on-error: true

      - name: Download k6 Stress Test reports
        uses: actions/download-artifact@v4
        with:
          name: k6-reports-stress
          path: k6-download/stress
        continue-on-error: true

      - name: Download k6 Security Test reports
        uses: actions/download-artifact@v4
        with:
          name: k6-reports-security
          path: k6-download/security
        continue-on-error: true

      - name: Merge all artifacts
        run: |
          echo "ğŸ“¦ Merging all artifacts into site directory..."
          
          # Copy Playwright reports
          if [ -d "playwright-download" ]; then
            echo "âœ… Merging Playwright reports..."
            cp -r playwright-download/* site/ 2>/dev/null || true
            ls -la site/reports/ || echo "No reports directory"
          fi
          
          # Copy k6 reports
          for test_type in load performance stress security; do
            if [ -d "k6-download/${test_type}" ]; then
              echo "âœ… Merging k6 ${test_type} reports..."
              cp -r k6-download/${test_type}/* site/k6/${test_type}/ 2>/dev/null || true
            else
              echo "âš ï¸ No k6 ${test_type} reports found"
            fi
          done
          
          echo ""
          echo "ğŸ“Š Final site structure:"
          tree site -L 3 2>/dev/null || find site -type f

      - name: Generate final dashboard
        env:
          PLAYWRIGHT_STATUS: ${{ needs.playwright.outputs.playwright_status || 'UNKNOWN' }}
          K6_STATUS: ${{ needs.k6.outputs.k6_status || 'UNKNOWN' }}
          BASE_URL: ${{ secrets.BASE_URL }}
        run: |
          echo "ğŸ¨ Generating final dashboard..."
          echo ""
          echo "ğŸ“ Working directory: $(pwd)"
          echo ""
          echo "ğŸ”§ Environment:"
          echo "  PLAYWRIGHT_STATUS: ${PLAYWRIGHT_STATUS}"
          echo "  K6_STATUS: ${K6_STATUS}"
          echo "  GITHUB_SHA: ${GITHUB_SHA}"
          echo "  GITHUB_REF: ${GITHUB_REF}"
          echo "  GITHUB_RUN_NUMBER: ${GITHUB_RUN_NUMBER}"
          echo ""
          
          # Verify script exists
          if [ ! -f "scripts/create-fallback-index.js" ]; then
            echo "âŒ ERROR: scripts/create-fallback-index.js not found!"
            echo "Available scripts:"
            ls -la scripts/
            exit 1
          fi
          
          echo "âœ… Running dashboard generator..."
          node scripts/create-fallback-index.js
          
          if [ $? -eq 0 ]; then
            echo ""
            echo "âœ… Dashboard generated successfully!"
            echo ""
            if [ -f "site/index.html" ]; then
              echo "ğŸ“„ index.html size: $(wc -c < site/index.html) bytes"
              echo ""
              echo "ğŸ“„ Dashboard preview (first 40 lines):"
              head -40 site/index.html
            fi
          else
            echo ""
            echo "âŒ Dashboard generation failed!"
            exit 1
          fi

      - name: Verify deployment files
        run: |
          echo "ğŸ” Verifying deployment files..."
          echo ""
          
          if [ ! -f "site/index.html" ]; then
            echo "âŒ ERROR: site/index.html not found!"
            exit 1
          fi
          
          echo "âœ… Required files:"
          echo "  - site/index.html ($(stat -c%s site/index.html 2>/dev/null || stat -f%z site/index.html) bytes)"
          
          echo ""
          echo "ğŸ“‚ All HTML files in site:"
          find site -name "*.html" -type f
          
          echo ""
          echo "ğŸ“‚ Complete site structure:"
          tree site -L 2 2>/dev/null || ls -R site

      - name: Configure GitHub Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… DEPLOYMENT SUCCESSFUL!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸŒ GitHub Pages URL:"
          echo "   ${{ steps.deployment.outputs.page_url }}"
          echo ""
          echo "ğŸ“Š Test Status:"
          echo "   Playwright: ${{ needs.playwright.outputs.playwright_status || 'UNKNOWN' }}"
          echo "   k6: ${{ needs.k6.outputs.k6_status || 'UNKNOWN' }}"
          echo ""
          echo "ğŸ”— Direct Links:"
          echo "   Dashboard: ${{ steps.deployment.outputs.page_url }}"
          echo "   Playwright: ${{ steps.deployment.outputs.page_url }}reports/ortoni-report.html"
          echo "   k6 Load: ${{ steps.deployment.outputs.page_url }}k6/load/index.html"
          echo "   k6 Performance: ${{ steps.deployment.outputs.page_url }}k6/performance/index.html"
          echo "   k6 Stress: ${{ steps.deployment.outputs.page_url }}k6/stress/index.html"
          echo "   k6 Security: ${{ steps.deployment.outputs.page_url }}k6/security/index.html"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"